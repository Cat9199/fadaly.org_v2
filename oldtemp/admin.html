{% extends 'base.html' %}
{% block content %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
    }
    
    th,
    td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    
    .button-link {
        display: inline-block;
        width: 80%;
        padding: 10px;
        background-color: #4CAF50;
        color: #fff;
        text-decoration: none;
        text-align: center;
        border-radius: 5px;
        border: none;
        cursor: pointer;
    }
    
    .button-link:hover {
        color: #ffffff;
        text-decoration: none;
    }
</style>


<center><h2>General statistics for the last month</h2></center>
<br>
  <canvas id="myChart" height="150px"></canvas>
  {% for x in entrance_data%}
  <div class="infoeinfo" style="display: none;">
    <strong class="day"><p class="pointName">{{ x.name }}</p><p class="pointDate">{{ x.date }}</p><p class="pointTime">{{ x.time }}</p></strong>
  </div>
  {% endfor %}
  <div style="display: flex;">
    <div id="myChart2" style="width:30%; max-width:600px; height:500px;"></div>
  <div id="myPlot" style="width:70%;"></div>

</div>
<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Time</th>
            <th>Date</th>
            <th>Location</th>
            <th>View</th>
            <th>Delete Attendace</th>
        </tr>
    </thead>
    <tbody>
        {% for x in alist %}
        <tr>
            <td>{{ x.user_id }}</td>
            <td>{{ x.name }}</td>
            <td>{{ x.time }}</td>
            <td>{{ x.date }}</td>
            <td>
                <center>
                    <a href="https://www.google.com/maps/place/{{ x.latitude }},{{ x.longitude }}" class="button-link">
                        <img src="https://raw.githubusercontent.com/Cat9199/Cat9199.github.io/main/pin.png" width='15px' style="margin: 0 10px 0 0 ;">location in google maps</a>
                </center>
            </td>
            <td>
                <center>
                    <a href="{{ url_for('vd',id=x.id) }}" class=" button-link " style=' background-color: #4C74AF'>
                        <img src="https://raw.githubusercontent.com/Cat9199/Cat9199.github.io/main/eye.png " width='15px' style="margin: 0 10px 0 0 ; ">View detail</a>
                </center>
            </td>
            <td>
                <center>
                    <a href="{{ url_for('dda',id=x.id) }}" class="button-link" style=' background-color: #af534c'>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
  <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"></path>
</svg> Delete
                    </a>
                </center>
            </td>
        </tr>
        {% endfor %}

    </tbody>
</table>
    
<script>
    // Fetch the data from your Flask route
    fetch('/chart-data')
      .then(response => response.json())
      .then(data => {
        const names = data.map(entry => entry[0]);
        const attendanceCounts = data.map(entry => entry[1]);
    
        const trace = {
          x: attendanceCounts,
          y: names,
          type: 'bar',
          orientation: 'h',
          marker: { color: 'rgba(255, 0, 0, 0.6)' }
        };
    
        const layout = {
          title: 'Attendance Counts by Name',
          xaxis: { title: '' },
          yaxis: { title: '' },
          autosize: true
        };
    
        const chartData = [trace];
    
        Plotly.newPlot('myPlot', chartData, layout);
      })
      .catch(error => {
        console.error('Error fetching data:', error);
      });
    </script>
  <script>
    // Initialize an empty xyValues array
    const xyValues = [];

    // Get all div elements with class "infoeinfo"
    const infoDivs = document.querySelectorAll(".infoeinfo");

    // Loop through each div element and extract data
    infoDivs.forEach((div) => {
      const pointNameElement = div.querySelector(".pointName");
      const pointDateElement = div.querySelector(".pointDate");
      const pointTimeElement = div.querySelector(".pointTime");
      const timee = pointTimeElement.textContent
      // Check if the elements exist before extracting data
      if (pointNameElement && pointDateElement && pointTimeElement) {
        const pointName = pointNameElement.textContent;
        const pointDate = moment(pointDateElement.textContent, 'YYYY-MM-DD'); // Use moment to parse date
        const pointTime = moment(`1970-01-01T${pointTimeElement.textContent}`, 'HH:mm:ss'); // Use moment to parse time

        // Push the data into the xyValues array
        xyValues.push({ x: pointDate, y: pointTime, label: `name :${pointName}Time:${timee}` });
      }
    });

    // Find the minimum and maximum time values in xyValues
    let minTime = moment('23:59:59', 'HH:mm:ss'); // Initialize with a large time
    let maxTime = moment('8:00:00', 'HH:mm:ss'); // Initialize with a small time

    xyValues.forEach((point) => {
      if (point.y.isBefore(minTime)) {
        minTime = point.y;
      }
      if (point.y.isAfter(maxTime)) {
        maxTime = point.y;
      }
    });

    // Calculate the date 30 days ago from today
    const thirtyDaysAgo = moment().subtract(30, 'days');
    function getRandomColor() {
        const r = Math.floor(Math.random() * 256);
        const g = Math.floor(Math.random() * 256);
        const b = Math.floor(Math.random() * 256);
        return `rgb(${r},${g},${b})`;
      }
    new Chart("myChart", {
      type: "scatter",
      data: {
        datasets: [{
          pointRadius: 4,
          pointBackgroundColor:`${getRandomColor()}`,
          data: xyValues,
          showLine: false,
          fill: false
        }]
      },
      options: {
        legend: { display: false },
        scales: {
          xAxes: [{
            type: 'time',
            time: {
              unit: 'day',
              min: thirtyDaysAgo,
              max: moment(),
              displayFormats: {
                day: 'MMM DD, YYYY'
              }
            },
            ticks: {
              maxTicksLimit: 30
            }
          }],
          yAxes: [{
            type: 'time',
            time: {
              unit: 'hour',
              displayFormats: {
                hour: 'HH:mm'
              },
              min: minTime,
              max: maxTime,
              stepSize: 3600 * 1000
            },
            ticks: {
              maxTicksLimit: 32
            }
          }],
        },
        tooltips: {
          callbacks: {
            label: function(tooltipItem, data) {
              return data.datasets[0].data[tooltipItem.index].label;
            }
          }
        }
      }
    });
  </script>  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(fetchAndDrawChart);

    function fetchAndDrawChart() {
      // Make an AJAX request to get the chart data
      $.ajax({
        url: '/chart-data',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          // Create a data table from the fetched data
          var chartData = google.visualization.arrayToDataTable(data);

          // Set chart options
          var options = {
            title: 'Entrance Records by Employee',
            is3D: true
          };

          // Draw the chart
          var chart = new google.visualization.PieChart(document.getElementById('myChart2'));
          chart.draw(chartData, options);
        },
        error: function(error) {
          console.error('Error fetching data:', error);
        }
      });
    }
  </script>
{% endblock %}
